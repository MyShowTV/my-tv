name: IPTV Proxy Sync

on:
  schedule:
    - cron: "0 */4 * * *"  # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: 
      - 'clash_config.yaml'  # é…ç½®æ–‡ä»¶å˜æ›´æ—¶ä¹Ÿè¿è¡Œ

env:
  PYTHON_VERSION: "3.9"
  CLASH_VERSION: "v1.18.0"
  REQUIREMENTS: |
    blinker==1.7.0
    requests==2.31.0
    selenium-wire==5.1.0
    selenium==4.9.1
    beautifulsoup4==4.12.2
    lxml==4.9.3

jobs:
  sync-iptv:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip
          # å®‰è£… Chrome å’Œ Chromedriver
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ${{ env.REQUIREMENTS }}
          pip install chromedriver-autoinstaller

      - name: ğŸš€ Start Clash Proxy
        run: |
          # ä¸‹è½½ Clash
          echo "ä¸‹è½½ Clash æ ¸å¿ƒ..."
          wget -q "https://github.com/Dreamacro/clash/releases/download/${CLASH_VERSION}/clash-linux-amd64-${CLASH_VERSION}.gz"
          gunzip "clash-linux-amd64-${CLASH_VERSION}.gz"
          mv "clash-linux-amd64-${CLASH_VERSION}" clash
          chmod +x clash
          
          # åˆ›å»ºç²¾ç®€ç‰ˆé…ç½®æ–‡ä»¶ï¼ˆåªä¿ç•™å°æ¹¾èŠ‚ç‚¹ï¼‰
          echo "åˆ›å»ºç²¾ç®€é…ç½®æ–‡ä»¶..."
          cat > clash_config_simple.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: global
          log-level: info
          
          proxies:
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨02"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17002
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨03"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17003
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨04"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17004
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨05"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17005
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨06"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17006
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨07"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17007
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨08"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17008
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨09"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17009
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "ğŸ‡¨ğŸ‡³ Taiwanä¸¨10"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17010
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
          
          proxy-groups:
            - name: "å°æ¹¾èŠ‚ç‚¹ç»„"
              type: select
              proxies:
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨01"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨02"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨03"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨04"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨05"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨06"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨07"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨08"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨09"
                - "ğŸ‡¨ğŸ‡³ Taiwanä¸¨10"
          
          rules:
            - MATCH,å°æ¹¾èŠ‚ç‚¹ç»„
          EOF
          
          # å¯åŠ¨ Clash
          echo "å¯åŠ¨ Clash..."
          ./clash -f clash_config_simple.yaml > clash.log 2>&1 &
          CLASH_PID=$!
          
          # ç­‰å¾…å¯åŠ¨
          sleep 15
          
          # æµ‹è¯•ä»£ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ
          echo "æµ‹è¯•ä»£ç†è¿æ¥..."
          for i in {1..5}; do
            RESPONSE=$(curl -s --max-time 10 -x http://127.0.0.1:7890 http://ip-api.com/json/ || echo '{"status":"fail"}')
            STATUS=$(echo $RESPONSE | jq -r '.status' 2>/dev/null || echo "error")
            
            if [[ "$STATUS" == "success" ]]; then
              COUNTRY=$(echo $RESPONSE | jq -r '.countryCode')
              IP=$(echo $RESPONSE | jq -r '.query')
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸ | IP: $IP | å›½å®¶: $COUNTRY"
              
              if [[ "$COUNTRY" == "TW" ]]; then
                echo "ğŸ¯ æˆåŠŸè¿æ¥åˆ°å°æ¹¾èŠ‚ç‚¹"
                echo "å°æ¹¾èŠ‚ç‚¹å·²å°±ç»ªï¼Œå¼€å§‹åŒæ­¥ä»»åŠ¡..."
                exit 0
              else
                echo "âš ï¸ ä»£ç†èŠ‚ç‚¹ä¸æ˜¯å°æ¹¾ (å®é™…: $COUNTRY)ï¼Œç»§ç»­æµ‹è¯•..."
              fi
            fi
            sleep 2
          done
          
          echo "âŒ æ— æ³•è¿æ¥åˆ°å°æ¹¾èŠ‚ç‚¹"
          kill $CLASH_PID 2>/dev/null || true
          exit 1

      - name: ğŸ”„ Execute Sync Script with Proxy
        run: |
          echo "è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡..."
          export http_proxy="http://127.0.0.1:7890"
          export https_proxy="http://127.0.0.1:7890"
          export HTTP_PROXY="http://127.0.0.1:7890"
          export HTTPS_PROXY="http://127.0.0.1:7890"
          
          echo "éªŒè¯ä»£ç†è®¾ç½®..."
          curl -s --max-time 10 http://ip-api.com/json/ | jq '.countryCode + " - " + .query'
          
          echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          python cloud_sync.py 2>&1 | tee sync.log
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“ Update Config Files
        if: success()
        run: |
          echo "æ£€æŸ¥é…ç½®æ–‡ä»¶æ›´æ–°..."
          
          # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ›´æ–°é…ç½®æ–‡ä»¶
          # ä¾‹å¦‚ï¼Œå¦‚æœæŠ“å–åˆ°äº†æ–°çš„ AssetIDï¼Œå¯ä»¥è‡ªåŠ¨æ›´æ–°
          if [[ -f "new_config.json" ]]; then
            echo "æ£€æµ‹åˆ°æ–°çš„é…ç½®ï¼Œæ­£åœ¨æ›´æ–°..."
            # å¤„ç†æ–°é…ç½®çš„é€»è¾‘
            python update_configs.py
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ’­æ”¾æº [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "ğŸ“¤ å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ¸…ç†è¿›ç¨‹..."
          pkill -f clash 2>/dev/null || true
          pkill -f chrome 2>/dev/null || true
          
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"

      - name: ğŸ“Š Upload Logs
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: sync-logs
          path: |
            clash.log
            sync.log
          retention-days: 7
