name: IPTV Proxy Sync

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Install Dependencies
        run: |
          # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆChromeæµè§ˆå™¨ï¼Œè§£å†³seleniumé©±åŠ¨é—®é¢˜ï¼‰
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip chromium-browser
          # å®‰è£…Pythonä¾èµ–
          python -m pip install --upgrade pip
          pip install blinker==1.7.0 requests selenium-wire==5.1.0 chromedriver-autoinstaller selenium==4.9.1

      # å¯é€‰ï¼šå¯åŠ¨Mihomoä»£ç†ï¼ˆè‹¥æœ‰æœ‰æ•ˆä»£ç†èŠ‚ç‚¹åˆ™å¼€å¯ï¼Œå¦åˆ™æ³¨é‡Šæ­¤æ­¥éª¤ï¼‰
      # - name: âš™ï¸ Start Mihomo Proxy
      #   run: |
      #     wget -q https://github.com/MetaCubeX/Mihomo/releases/download/v1.18.9/mihomo-linux-amd64-v1.18.9.gz
      #     gunzip mihomo-linux-amd64-v1.18.9.gz
      #     chmod +x mihomo-linux-amd64-v1.18.9
      #     # æ›¿æ¢ä¸ºæœ‰æ•ˆä»£ç†é…ç½®ï¼ˆç¤ºä¾‹ä¸ºSSï¼Œéœ€æ”¹æˆè‡ªå·±çš„ï¼‰
      #     cat <<EOF > config.yaml
      # mixed-port: 7890
      # allow-lan: true
      # mode: global
      # log-level: info
      # proxies:
      #   - name: "TW-NODE"
      #     type: ss
      #     server: your-valid-tw-server.com
      #     port: your-port
      #     cipher: aes-256-gcm
      #     password: your-password
      #     udp: false
      # EOF
      #     ./mihomo-linux-amd64-v1.18.9 -f config.yaml > mihomo.log 2>&1 &
      #     sleep 30
      #     # æ£€æµ‹ä»£ç†æ˜¯å¦ç”Ÿæ•ˆ
      #     curl -s --max-time 15 -x http://127.0.0.1:7890 http://ip-api.com/json/

      - name: ğŸš€ Execute Sync Script
        run: python cloud_sync.py

      - name: ğŸ§¾ Show Logs
        if: always()
        run: |
          # æ˜¾ç¤ºMihomoæ—¥å¿—ï¼ˆè‹¥å¯åŠ¨äº†ä»£ç†ï¼‰
          if [ -f mihomo.log ]; then
            tail -n 50 mihomo.log || true
          fi
          # æ¸…ç†è¿›ç¨‹
          pkill -f mihomo-linux-amd64-v1.18.9 || true
