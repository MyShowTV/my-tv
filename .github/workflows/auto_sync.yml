name: IPTV Proxy Sync

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEFAULT_PORT: 17001
    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Mihomo & Detect Taiwan IP
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl wget
          wget -q https://github.com/MetaCubeX/Mihomo/releases/download/v1.18.9/mihomo-linux-amd64-v1.18.9.gz
          gunzip mihomo-linux-amd64-v1.18.9.gz
          chmod +x mihomo-linux-amd64-v1.18.9

          # å¹¶è¡Œæµ‹è¯•ç«¯å£èŒƒå›´
          PORTS=$(seq 17001 17015 | xargs -I{} sh -c 'echo "{}"')
          SUCCESS=false
          VALID_PORTS=()

          # å¹¶è¡Œæµ‹è¯•å‡½æ•°
          test_port() {
            local port=$1
            local log_file="mihomo_$port.log"
            local config="config_$port.yaml"

            cat <<EOF > $config
mixed-port: 7890
allow-lan: true
mode: rule
log-level: warning
proxies:
  - name: "TW-NODE-$port"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: $port
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
rules:
  - DOMAIN-SUFFIX,ofiii.com,TW-NODE-$port
  - DOMAIN,ip-api.com,TW-NODE-$port
  - MATCH,DIRECT
EOF

            ./mihomo-linux-amd64-v1.18.9 -f $config > $log_file 2>&1 &
            sleep 10  # ç¼©çŸ­åˆå§‹åŒ–ç­‰å¾…æ—¶é—´
            
            # æ™ºèƒ½é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              CHECK=$(curl -s --max-time 10 -x http://127.0.0.1:7890 http://ip-api.com/json/ || echo '{"countryCode":"FAIL"}')
              COUNTRY=$(echo $CHECK | jq -r '.countryCode' 2>/dev/null || echo "ERROR")
              IP=$(echo $CHECK | jq -r '.query' 2>/dev/null || echo "UNKNOWN")
              
              if [[ "$COUNTRY" == "TW" ]]; then
                echo "âœ… ç«¯å£ $port éªŒè¯æˆåŠŸ | IP: $IP"
                VALID_PORTS+=($port)
                pkill -f mihomo
                return 0
              fi
              sleep 5
            done
            
            pkill -f mihomo || true
            echo "âŒ ç«¯å£ $port éªŒè¯å¤±è´¥"
            return 1
          }

          # å¯¼å‡ºå‡½æ•°ä»¥ä¾¿å­è¿›ç¨‹ä½¿ç”¨
          export -f test_port

          # å¹¶è¡Œæ‰§è¡Œæµ‹è¯•
          echo "$PORTS" | xargs -n1 -I{} -P 15 bash -c 'test_port "$@"' _ {}

          # å›é€€é€»è¾‘
          if [ ${#VALID_PORTS[@]} -gt 0 ]; then
            SELECTED_PORT=${VALID_PORTS[0]}
            echo "ğŸš€ ä½¿ç”¨æœ‰æ•ˆç«¯å£: $SELECTED_PORT"
          else
            SELECTED_PORT=$DEFAULT_PORT
            echo "ğŸ”¥ å›é€€åˆ°é»˜è®¤ç«¯å£: $SELECTED_PORT"
          fi

          # æœ€ç»ˆå¯åŠ¨æœåŠ¡
          cat <<EOF > final_config.yaml
mixed-port: 7890
allow-lan: true
mode: rule
log-level: info
proxies:
  - name: "TW-FINAL"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: $SELECTED_PORT
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
rules:
  - DOMAIN-SUFFIX,ofiii.com,TW-FINAL
  - DOMAIN,ip-api.com,TW-FINAL
  - MATCH,DIRECT
EOF

          ./mihomo-linux-amd64-v1.18.9 -f final_config.yaml
