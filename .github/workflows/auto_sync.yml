name: IPTV Proxy Sync Optimized

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  proxy_sync:
    runs-on: ubuntu-latest
    env:
      DEFAULT_PORT: 17001
      MAX_RETRIES: 3
      TIMEOUT_SEC: 15
    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz
          gunzip mihomo-linux-amd64-v1.19.3.gz
          chmod +x mihomo-linux-amd64-v1.19.3

      - name: üåê Parallel Port Testing
        id: port_test
        run: |
          PORTS=$(seq 17001 17015)
          VALID_PORTS=()
          LOG_DIR="./test_logs"
          mkdir -p $LOG_DIR

          test_port() {
            local port=$1
            local log="$LOG_DIR/mihomo_$port.log"
            local config="config_$port.yaml"

            cat <<EOF > $config
mixed-port: 7890
allow-lan: true
mode: rule
log-level: warning
proxies:
  - name: "TW-NODE-$port"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: $port
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
rules:
  - DOMAIN-SUFFIX,ofiii.com,TW-NODE-$port
  - DOMAIN,ip-api.com,TW-NODE-$port
  - MATCH,DIRECT
EOF

            ./mihomo-linux-amd64-v1.19.3 -f $config > $log 2>&1 &
            sleep 10

            for attempt in $(seq 1 $MAX_RETRIES); do
              CHECK=$(curl -s --max-time $TIMEOUT_SEC -x http://127.0.0.1:7890 https://ipinfo.io/country?token=${{ secrets.IPINFO_TOKEN }} || echo 'FAIL')
              if [[ "$CHECK" == "TW" ]]; then
                echo "‚úÖ Á´ØÂè£ $port È™åËØÅÊàêÂäü (Â∞ùËØï $attempt/$MAX_RETRIES)"
                VALID_PORTS+=($port)
                pkill -f mihomo
                return 0
              fi
              sleep 5
            done

            pkill -f mihomo
            echo "‚ùå Á´ØÂè£ $port È™åËØÅÂ§±Ë¥•" >> $log
            return 1
          }

          export -f test_port
          echo "$PORTS" | xargs -n1 -I{} -P 8 bash -c 'test_port "$@"' _ {}

          if [ ${#VALID_PORTS[@]} -gt 0 ]; then
            SELECTED_PORT=${VALID_PORTS[0]}
            echo "SELECTED_PORT=$SELECTED_PORT" >> $GITHUB_ENV
          else
            SELECTED_PORT=$DEFAULT_PORT
            echo "SELECTED_PORT=$SELECTED_PORT" >> $GITHUB_ENV
          fi

      - name: üöÄ Final Service Startup
        run: |
          cat <<EOF > final_config.yaml
mixed-port: 7890
allow-lan: true
mode: rule
log-level: info
proxies:
  - name: "TW-FINAL"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: ${{ env.SELECTED_PORT }}
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
rules:
  - DOMAIN-SUFFIX,ofiii.com,TW-FINAL
  - DOMAIN,ipinfo.io,TW-FINAL
  - MATCH,DIRECT
EOF

          ./mihomo-linux-amd64-v1.19.3 -f final_config.yaml

      - name: üìÖ Log Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: ./test_logs/
