name: IPTV Proxy Sync

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Environment & Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget psmisc
          # ä¸‹è½½å¹¶è§£å‹Mihomoï¼Œç®€åŒ–æ–‡ä»¶åé¿å…è·¯å¾„é—®é¢˜
          wget -q https://github.com/MetaCubeX/Mihomo/releases/download/v1.18.9/mihomo-linux-amd64-v1.18.9.gz -O mihomo.gz
          gunzip mihomo.gz
          mv mihomo mihomo-linux-amd64
          chmod +x mihomo-linux-amd64
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f ./mihomo-linux-amd64 ]; then
            echo "âŒ Mihomoæ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: âš™ï¸ Detect Taiwan IP
        run: |
          SUCCESS=false
          VALID_PORT=""
          # å…ˆæ¸…ç†å¯èƒ½æ®‹ç•™çš„Mihomoè¿›ç¨‹
          pkill -f mihomo-linux-amd64 || true
          sleep 2

          for p in $(seq 17001 17015); do
            echo "-----------------------------------"
            echo "ğŸ” æ­£åœ¨å°è¯•ç«¯å£: $p"
            
            # ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®ï¼Œå…³é—­æ— ç”¨çš„udpå‡å°‘èµ„æºå ç”¨
            cat <<EOF > config.yaml
mixed-port: 7890
allow-lan: true
mode: global
log-level: warn  # é™ä½æ—¥å¿—çº§åˆ«ï¼Œå‡å°‘è¾“å‡º
external-controller: 127.0.0.1:9090
proxies:
  - name: "TW-NODE"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: $p
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
    udp: false
proxy-groups:
  - name: "PROXY"
    type: select
    proxies:
      - "TW-NODE"
EOF

            # å¯åŠ¨Mihomoï¼Œé‡å®šå‘æ—¥å¿—ï¼Œåå°è¿è¡Œ
            ./mihomo-linux-amd64 -f config.yaml > mihomo_$p.log 2>&1 &
            MIHO_PID=$!
            echo "ğŸ“Œ Mihomoè¿›ç¨‹ID: $MIHO_PID"

            # ç­‰å¾…Mihomoå®Œå…¨å¯åŠ¨ï¼ˆå»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿ä»£ç†æœåŠ¡å°±ç»ªï¼‰
            sleep 30

            # æµ‹è¯•ä»£ç†è¿é€šæ€§ï¼Œå…ˆpingæœ¬åœ°ä»£ç†ç«¯å£ï¼Œå†è¯·æ±‚IPä¿¡æ¯
            if ! nc -z 127.0.0.1 7890; then
              echo "âŒ ä»£ç†ç«¯å£7890æœªå¯åŠ¨ï¼Œè·³è¿‡ç«¯å£$p"
              kill $MIHO_PID || true
              wait $MIHO_PID 2>/dev/null
              sleep 2
              continue
            fi

            # ä½¿ç”¨æ›´ç¨³å®šçš„IPæŸ¥è¯¢æ¥å£ï¼Œå¢åŠ é‡è¯•æœºåˆ¶
            CHECK=$(curl -s --max-time 20 --retry 2 -x http://127.0.0.1:7890 https://ipapi.co/json/ || echo '{"country_code":"FAILED"}')
            # å…¼å®¹ä¸¤ä¸ªæ¥å£çš„å­—æ®µåï¼ˆip-apiç”¨countryCodeï¼Œipapiç”¨country_codeï¼‰
            COUNTRY=$(echo $CHECK | jq -r '.countryCode // .country_code' 2>/dev/null || echo "ERROR")
            IP=$(echo $CHECK | jq -r '.query // .ip' 2>/dev/null || echo "UNKNOWN")
            
            echo "ğŸŒ å‡ºå£ IP: $IP | å½’å±åœ°: $COUNTRY"

            if [[ "$COUNTRY" == "TW" || "$COUNTRY" == "tw" ]]; then
              echo "âœ… æˆåŠŸé”å®šå°æ¹¾èŠ‚ç‚¹ (ç«¯å£ $p)"
              SUCCESS=true
              VALID_PORT=$p
              # ä¿ç•™å½“å‰Mihomoè¿›ç¨‹ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
              break
            else
              echo "âŒ ç«¯å£ $p å½’å±åœ°ä¸æ˜¯å°æ¹¾ï¼Œå°è¯•ä¸‹ä¸€ä¸ª..."
              kill $MIHO_PID || true
              wait $MIHO_PID 2>/dev/null
              sleep 2
              # æ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
              rm -f mihomo_$p.log
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆçš„å°æ¹¾å‡ºå£èŠ‚ç‚¹ã€‚"
            # æ¸…ç†æ‰€æœ‰æ—¥å¿—
            rm -f mihomo_*.log
            exit 1
          else
            # å°†æœ‰æ•ˆç«¯å£å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "VALID_PORT=$VALID_PORT" >> $GITHUB_ENV
            echo "âœ… æœ‰æ•ˆå°æ¹¾èŠ‚ç‚¹ç«¯å£: $VALID_PORT"
          fi

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install blinker==1.7.0 requests selenium-wire==5.1.0 chromedriver-autoinstaller selenium==4.9.1

      - name: ğŸš€ Execute Sync Script
        run: python cloud_sync.py
        env:
          # ä¼ é€’æœ‰æ•ˆç«¯å£åˆ°åŒæ­¥è„šæœ¬ï¼ˆå¦‚æœè„šæœ¬éœ€è¦ï¼‰
          VALID_PORT: ${{ env.VALID_PORT }}

      - name: ğŸ§¾ Show Logs
        if: always()
        run: |
          # æ˜¾ç¤ºæœ€åæ‰¾åˆ°çš„æœ‰æ•ˆç«¯å£æ—¥å¿—ï¼Œè‹¥æ— åˆ™æ˜¾ç¤ºæ‰€æœ‰
          if [ -n "${{ env.VALID_PORT }}" ]; then
            tail -n 50 mihomo_${{ env.VALID_PORT }}.log || true
          else
            tail -n 50 mihomo.log || true
          fi
          # æ¸…ç†è¿›ç¨‹
          pkill -f mihomo-linux-amd64 || true
